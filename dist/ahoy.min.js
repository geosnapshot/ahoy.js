!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ahoy=t()}(this,function(){"use strict";function c(e){return void 0===e}function u(e){return Array.isArray(e)}function f(e){return e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.slice}var o=function i(n,r,o,a){var e,t;if(r instanceof FormData&&(a=o,o=r,r=null),(r=r||{}).indices=!c(r.indices)&&r.indices,r.nulls=!!c(r.nulls)||r.nulls,o=o||new FormData,c(n))return o;if(null===n)r.nulls&&o.append(a,"");else if(u(n))if(n.length)n.forEach(function(e,t){var n=a+"["+(r.indices?t:"")+"]";i(e,r,o,n)});else{var s=a+"[]";o.append(s,"")}else n instanceof Date?o.append(a,n.toISOString()):(t=n)!==Object(t)||f(e=n)&&("object"==typeof e.lastModifiedDate||"number"==typeof e.lastModified)&&"string"==typeof e.name||f(n)?o.append(a,n):Object.keys(n).forEach(function(e){var t=n[e];if(u(t))for(;2<e.length&&e.lastIndexOf("[]")===e.length-2;)e=e.substring(0,e.length-2);i(t,r,o,a?a+"["+e+"]":e)});return o},i={set:function(e,t,n,i){var r="",o="";if(n){var a=new Date;a.setTime(a.getTime()+60*n*1e3),r="; expires="+a.toGMTString()}i&&(o="; domain="+i);var s,c=e+"="+escape(t)+r+o+"; path=/";document.location.protocol&&(c+="; secure"),(s=navigator.userAgent).includes("iPhone OS 12_")||s.includes("iPad; CPU OS 12_")||s.includes("Chrome/5")||s.includes("Chrome/6")||s.includes(" OS X 10_14_")&&s.includes("Version/")&&s.includes("Safari")||(c+="; SameSite=None"),document.cookie=c},get:function(e){var t,n,i=e+"=",r=document.cookie.split(";");for(t=0;t<r.length;t++){for(n=r[t];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(i))return unescape(n.substring(i.length,n.length))}return null}},a={urlPrefix:"",visitsUrl:"/ahoy/visits",eventsUrl:"/ahoy/events",page:null,platform:"Web",useBeacon:!0,startOnReady:!0,trackVisits:!0,cookies:!0,cookieDomain:null,headers:{},visitParams:{},withCredentials:!1},r=window.ahoy||window.Ahoy||{};r.configure=function(e){for(var t in e)e.hasOwnProperty(t)&&(a[t]=e[t])},r.configure(r);var n,s,d,e,l=window.jQuery||window.Zepto||window.$,h=!1,t=[],v="undefined"!=typeof JSON&&void 0!==JSON.stringify,g=[];function p(){return a.urlPrefix+a.eventsUrl}function m(){return(a.useBeacon||a.trackNow)&&(e=a.headers,0===Object.keys(e).length)&&v&&void 0!==window.navigator.sendBeacon&&!a.withCredentials;var e}function y(e,t,n){i.set(e,t,n,a.cookieDomain||a.domain)}function k(e){return i.get(e)}function w(e){i.set(e,"",-1)}function x(e){k("ahoy_debug")&&window.console.log(e)}function _(){for(var e;e=t.shift();)e();h=!0}function S(e){h?e():t.push(e)}function b(e,r,o){document.addEventListener(e,function(e){var t,n,i;t=e.target,n=r,((i=t.matches||t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector)?i.apply(t,[n]):void x("Unable to match"))&&o(e)})}function O(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function C(){a.cookies&&v&&y("ahoy_events",JSON.stringify(g),1)}function P(){var e=document.querySelector("meta[name=csrf-token]");return e&&e.content}function T(e){var t=P();t&&e.setRequestHeader("X-CSRF-Token",t)}function V(e,t,n){if(v)if(l&&l.ajax)l.ajax({type:"POST",url:e,data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:T,success:n,headers:a.headers,xhrFields:{withCredentials:a.withCredentials}});else{var i=new XMLHttpRequest;for(var r in i.open("POST",e,!0),i.withCredentials=a.withCredentials,i.setRequestHeader("Content-Type","application/json"),a.headers)a.headers.hasOwnProperty(r)&&i.setRequestHeader(r,a.headers[r]);i.onload=function(){200===i.status&&n()},T(i),i.send(JSON.stringify(t))}}function j(e){var t={events:[e]};return a.cookies&&(t.visit_token=e.visit_token,t.visitor_token=e.visitor_token),delete e.visit_token,delete e.visitor_token,t}function N(t){S(function(){V(p(),j(t),function(){for(var e=0;e<g.length;e++)if(g[e].id==t.id){g.splice(e,1);break}C()})})}function M(r){S(function(){var e,t=j(r),n=(e=document.querySelector("meta[name=csrf-param]"))&&e.content,i=P();n&&i&&(t[n]=i),t.events_json=JSON.stringify(t.events),delete t.events,window.navigator.sendBeacon(p(),o(t))})}function A(){return a.page||window.location.pathname}function D(e){return e&&0<e.length?e:null}function I(e){var t=e.target;return function(e){for(var t in e)e.hasOwnProperty(t)&&null===e[t]&&delete e[t];return e}({tag:t.tagName.toLowerCase(),id:D(t.id),class:D(t.className),page:A(),section:function(e){for(;e&&e!==document;e=e.parentNode)if(e.hasAttribute("data-section"))return e.getAttribute("data-section");return null}(t)})}function J(){if(h=!1,n=r.getVisitId(),s=r.getVisitorId(),d=k("ahoy_track"),!1===a.cookies||!1===a.trackVisits)x("Visit tracking disabled"),_();else if(n&&s&&!d)x("Active visit"),_();else if(n||y("ahoy_visit",n=O(),240),k("ahoy_visit")){x("Visit started"),s||y("ahoy_visitor",s=O(),1051200);var e={visit_token:n,visitor_token:s,platform:a.platform,landing_page:window.location.href,screen_width:window.screen.width,screen_height:window.screen.height,js:!0};for(var t in 0<document.referrer.length&&(e.referrer=document.referrer),a.visitParams)a.visitParams.hasOwnProperty(t)&&(e[t]=a.visitParams[t]);x(e),V(a.urlPrefix+a.visitsUrl,e,function(){w("ahoy_track"),_()})}else x("Cookies disabled"),_()}r.getVisitId=r.getVisitToken=function(){return k("ahoy_visit")},r.getVisitorId=r.getVisitorToken=function(){return k("ahoy_visitor")},r.reset=function(){return w("ahoy_visit"),w("ahoy_visitor"),w("ahoy_events"),w("ahoy_track"),!0},r.debug=function(e){return!1===e?w("ahoy_debug"):y("ahoy_debug","t",525600),!0},r.track=function(e,t){var n={name:e,properties:t||{},time:(new Date).getTime()/1e3,id:O(),js:!0};return S(function(){a.cookies&&!r.getVisitId()&&J(),S(function(){x(n),n.visit_token=r.getVisitId(),n.visitor_token=r.getVisitorId(),m()?M(n):(g.push(n),C(),setTimeout(function(){N(n)},1e3))})}),!0},r.trackView=function(e){var t={url:window.location.href,title:document.title,page:A()};if(e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);r.track("$view",t)},r.trackClicks=function(){b("click","a, button, input[type=submit]",function(e){var t=e.target,n=I(e);n.text="input"==n.tag?t.value:(t.textContent||t.innerText||t.innerHTML).replace(/[\s\r\n]+/g," ").trim(),n.href=t.href,r.track("$click",n)})},r.trackSubmits=function(){b("submit","form",function(e){var t=I(e);r.track("$submit",t)})},r.trackChanges=function(){b("change","input, textarea, select",function(e){var t=I(e);r.track("$change",t)})},r.trackAll=function(){r.trackView(),r.trackClicks(),r.trackSubmits(),r.trackChanges()};try{g=JSON.parse(k("ahoy_events")||"[]")}catch(e){}for(var R=0;R<g.length;R++)N(g[R]);return r.start=function(){J(),r.start=function(){}},e=function(){a.startOnReady&&r.start()},"interactive"===document.readyState||"complete"===document.readyState?setTimeout(e,0):document.addEventListener("DOMContentLoaded",e),r});
